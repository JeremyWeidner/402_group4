---
title: "402_final_proj_eda"
author: "Harrison DiStefano"
date: "11/29/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown
```{r load data}
# Only works in rstudio
file_directory <- dirname(rstudioapi::getActiveDocumentContext()$path)
setwd(file_directory)
hotels <- read.csv("../raw_data/hotel_bookings.csv")
head(hotels)
summary(hotels)
```

```{r correlation plot}
library(dplyr)
library(reshape2)
library(ggplot2)

# Get data into a useable shape
hotels_numeric <- hotels %>% 
                    select(where(is.numeric)) %>%
                    select(-children)  # Children is ordinal
corr_matrix <- cor(hotels_numeric)
corr_matrix[upper.tri(corr_matrix)] <- NA  # Get only upper triangle of heatmap
melted_corr <- melt(corr_matrix, na.rm = TRUE)

# Plot
heatmap <- ggplot(data = melted_corr, aes(x=Var1, y=Var2, fill=value)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white",
                       midpoint = 0, limit = c(-1,1), space = "Lab",
                       name = "Pearson\nCorrelation") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = .25,
                                   size = 10, hjust = 1)) + 
  coord_fixed()

heatmap +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.border = element_blank()
  )
```

```{r required car spaces histogram}
# Histogram of required car parking spaces
ggplot(data = hotels, aes(x=required_car_parking_spaces, group=is_canceled, fill=is_canceled)) +
  geom_histogram(position = "dodge", binwidth = 0.5) +
  theme(legend.position = "none")
```

```{r required car spaces proportion}
# Percent of reservations canceled by required car parking spaces
ggplot(data = hotels, aes(x=required_car_parking_spaces, group=is_canceled, fill=factor(is_canceled))) +
  geom_bar(position = "fill") +
  ylab("proportion") +
  labs(fill = "is_canceled")
```

```{r agent}
# TRUE if an agent was used for the booking, FALSE otherwise
hotels$used_agent <- hotels$agent != "NULL"

# Used agent by cancellation rate
ggplot(data = hotels, aes(x=used_agent, group=is_canceled, fill=factor(is_canceled))) +
  geom_bar(position = "fill") +
  ylab("proportion") +
  labs(fill = "is_canceled")

# Could possibly compare agents that have a large number of bookings
ggplot(data = hotels, aes(x=agent)) +
  geom_histogram(stat = "count")
```

```{r deposit type}
# Deposit type by cancellation rate
ggplot(data = hotels, aes(x=deposit_type, group=is_canceled, fill=factor(is_canceled))) +
  geom_bar(position = "fill") +
  ylab("proportion") +
  labs(fill = "is_canceled")
```


```{r international booking}
# Assuming the two hotels are in Portugal
hotels$international_booking <- hotels$country != "PRT"

ggplot(data = hotels, aes(x=international_booking, group=is_canceled, fill=factor(is_canceled))) +
  geom_bar(position = "fill") +
  ylab("proportion") +
  labs(fill = "is_canceled")
```

## Added some stuff: 

# Cross-Correlations: 

```{r}
devtools::install_github("laresbernardo/lares")
library(lares) # colinearity analysis
options("lares.font" = FALSE)
hotels$is_canceled <- as.factor(hotels$is_canceled)
corr_cross(hotels_numeric, 
           max_pvalue = 0.05,
           top = 10, 
           rm.na = TRUE)

corr_var(hotels_numeric, 
         is_canceled, 
         top = 5)
```


# Feature Selection: 

```{r}
library(randomForest)
library(randomForestExplainer)
hotels <- na.omit(hotels)

hotels.n <- hotels %>% mutate_if(is.character, is.factor)
set.seed(1) # for reproducibility 
train <- sample(1:nrow(hotels.n), nrow(hotels.n)*.7) # doing a 70/30 split on the data
train.dt <- hotels.n[train,]
test.dt <- hotels.n[-train,]

rf.dt <- randomForest(is_canceled~., data = train.dt, mtry = 6, importance = TRUE, ntrees = 500, na.action = na.omit)

# importance(rf.dt)
varImpPlot(rf.dt)
# Mean Decrease in Gini is the average (mean) of a variableâ€™s total decrease in node impurity, weighted by the proportion of samples reaching that node in each individual decision tree in the random forest. 
# A higher Mean Decrease in Gini indicates higher variable importance.

pred <- predict(rf.dt, test.dt, type = "response")
table(pred, test.dt$is_canceled)
mean(pred != test.dt$is_canceled) # test error rate 
```
